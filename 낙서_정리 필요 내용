!!API 연동은 일단 테스트 집계 처리 다음에 한다.
!!!source 는 하나로 관리해야 -> fail 처리할 수 있다.
!!!하지만, 모니터링 부분은 어쩔 수 없이 DB 에서 해야 할 듯 함!!

* 30초에 한 번씩 => vodInfo (? serviceIp, ? serviceState:running, ...) ser 얻어와(테스트 코드로 한다), 
 - 목=> 홈초이스 서버(? LSM, STR)에서 설정상 ON 상태인 서버를,  ON 에서 가끔 OFF 로 변경
 ==> server_id, server_ip, 

* 30초에 한 번씩 => sessions 얻어와(테스트 코드로 한다), 
 - 세션트래픽: vodIp(6개), stbIp(1000개), fileName(1만개), currentBandwidth(20000000)

 - flag 테이블 사용, xx_1, xx_2 의 2개 테이블에서 '서비스 중'인 테이블의 번호를 적어 구분한다.
  서버=> vodIp, stbIp, fileName 키로 *** agg !!!  => count, traffic 구함(합)

  db=> 서버별: vodIp(홈초이스 vod server_ip) 로 server_id, server_nm 구하고,
       server_id 별 traffic 합 agg
       조인 tbl_llt_setting_server on server_id => get traffic_critical, process_status, traffic_status
  db=> so 별:stbIp(so vod server_ip) 로 so_cd, so_nm 구하고,
       so_cd 별 traffic 합 agg
       조인 tbl_llt_setting_so on so_cd

  db=> 서버 임계치, so 임계치, so-콘텐츠 임계치 테이블 JOIN 등으로
       알람 발생 확인
       알람 이력 확인
     ==> 알람 발생(이력 생성) 
     { 새로 발생한 것은 알람 이력 생성, '알람on' 표시(agg에 현재 발생 알람 갖고 있어야함)
       없어진 것은 update 처리로 '알람off' 표시
       - 알람종류 3: 서버, so, so-콘텐츠
     }

...ing

 - temp 테이블에 저장. event_time 은 
 - vodIp, vodName, fileName, currentBandwidth, stbIp + currentTime(현재시간)
 


!! 5분 hcVodServer, SO 평균 hitCount, traffic 구하기
 - 30초 모니터링시 x0,x5분일 경우 모니터링보다 먼저 시행.
   history테이블 보고 이전 몇 번 모니터링 했는지 count 확인.
  (endIdx 남김, monitoring_count 남김)
 - 30초 모니터링 테이블 => 5분 모니터링 테이블로 집계
 - 30초 모니터링 테이블 Truncate, history테이블 endIdx 0, count 0 업데이트
---> 일단 OK.


* 1시간 주기로 report 테이블 집계.
 - 매시 3분에 시작
 - vod_log : ReportCollector 에서 DB에 넣어줌, auto_increment 걸러 id 넣어준다!!
  => id 기반으로 이력을 관리하여 fail 에 대비하여 이력 남김
   => id, server_ip(?홈초이스 vod 서버), client_ip(?so의 vod 서버)
      , log_date(? sess_e_dtime와 같은 값으로, hitcount 기준?)
      , filename

 - DB의 로그를 서버로 읽어와서 => 메모리에서 '시, 일, 월' 단위로 집계한다.
   insert & update 되도록 'ON duplicate key update ' 구문 넣음.
    => 같은키로 다시 넣을 때 update 되는지 확인 필요!! 
       기존 테스트는 select .. group by 로 에러는 나지 않았으나, 업데이트는 되지 않았던 것 같음.
   



3. 테이블 만들어 넣기.
temp_vodsessionper30sec (
)

CREATE TABLE tbl_llt_sessionsper5minute (
  event_time datetime NOT NULL COMMENT '등록시간',
  date varchar(8) NOT NULL,
  hour int NOT NULL,
  minute int NOT NULL,
  server_id varchar(45) NOT NULL COMMENT 'server 식별 ID',
  server_nm varchar(255) DEFAULT NULL,
  so_cd varchar(45) NOT NULL,
  so_nm varchar(255) DEFAULT NULL,
  traffic bigint NOT NULL DEFAULT '0',
  hit_count int NOT NULL DEFAULT '0',
  UNIQUE KEY sessionsper5minute_uk (date,hour,minute,server_id,so_cd),
  KEY time_idx (event_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

CREATE TABLE tbl_llt_servertrafficperhour (
  date varchar(8) NOT NULL,
  hour int NOT NULL,
  server_id varchar(45) NOT NULL COMMENT 'server 식별 ID',
  server_nm varchar(255) DEFAULT NULL,
  traffic bigint NOT NULL DEFAULT '0',
  UNIQUE KEY servertrafficperhour_uk (date,hour,server_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

CREATE TABLE tbl_llt_servertrafficperday (
  day_of_week tinyint NOT NULL COMMENT '요일',
  week_of_year tinyint NOT NULL COMMENT 'week number',
  date varchar(8) NOT NULL,
  server_id varchar(45) NOT NULL COMMENT 'server 식별 ID',
  server_nm varchar(255) DEFAULT NULL,
  traffic bigint NOT NULL DEFAULT '0',
  UNIQUE KEY servertrafficperday_uk (date,server_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

CREATE TABLE tbl_llt_servertrafficpermonth (
  date varchar(6) NOT NULL,
  server_id varchar(45) NOT NULL COMMENT 'server 식별 ID',
  server_nm varchar(255) DEFAULT NULL,
  traffic bigint NOT NULL DEFAULT '0',
  UNIQUE KEY servertrafficpermonth_uk (date,server_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

CREATE TABLE tbl_llt_sotrafficperhour (
  date varchar(8) NOT NULL,
  hour int NOT NULL,
  so_cd varchar(45) NOT NULL,
  so_nm varchar(255) DEFAULT NULL,
  traffic bigint NOT NULL DEFAULT '0',
  UNIQUE KEY sotrafficperhour_uk (date,hour,so_cd)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

CREATE TABLE tbl_llt_sotrafficperday (
  day_of_week tinyint NOT NULL COMMENT '요일',
  week_of_year tinyint NOT NULL COMMENT 'week number',
  date varchar(8) NOT NULL,
  so_cd varchar(45) NOT NULL,
  so_nm varchar(255) DEFAULT NULL,
  traffic bigint NOT NULL DEFAULT '0',
  UNIQUE KEY sotrafficperday_uk (date,so_cd)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

CREATE TABLE tbl_llt_sotrafficpermonth (
  date varchar(6) NOT NULL,
  so_cd varchar(45) NOT NULL,
  so_nm varchar(255) DEFAULT NULL,
  traffic bigint NOT NULL DEFAULT '0',
  UNIQUE KEY sotrafficpermonth_uk (date,so_cd)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;


/*vod_log 로 아래 집계*/
CREATE TABLE tbl_llt_servercontenthitcountperhour (
  date varchar(8) NOT NULL,
  hour int NOT NULL,
  server_id varchar(45) NOT NULL COMMENT 'server 식별 ID',
  server_nm varchar(255) DEFAULT NULL,
  file_name varchar(100) NOT NULL,
  hit_count int NOT NULL DEFAULT '0',
  UNIQUE KEY servercontenthitcountperhour_uk (date,hour,server_id,file_name)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

CREATE TABLE tbl_llt_servercontenthitcountperday (
  day_of_week tinyint NOT NULL COMMENT '요일',
  week_of_year tinyint NOT NULL COMMENT 'week number',
  date varchar(8) NOT NULL,
  server_id varchar(45) NOT NULL COMMENT 'server 식별 ID',
  server_nm varchar(255) DEFAULT NULL,
  file_name varchar(100) NOT NULL,
  hit_count int NOT NULL DEFAULT '0',
  UNIQUE KEY servercontenthitcountperday_uk (date,server_id,file_name)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

CREATE TABLE tbl_llt_servercontenthitcountpermonth (
  date varchar(6) NOT NULL,
  server_id varchar(45) NOT NULL COMMENT 'server 식별 ID',
  server_nm varchar(255) DEFAULT NULL,
  file_name varchar(100) NOT NULL,
  hit_count int NOT NULL DEFAULT '0',
  UNIQUE KEY servercontenthitcountpermonth_uk (date,server_id,file_name)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

CREATE TABLE tbl_llt_socontenthitcountperhour (
  date varchar(8) NOT NULL,
  hour int NOT NULL,
  so_cd varchar(45) NOT NULL,
  so_nm varchar(255) DEFAULT NULL,
  file_name varchar(100) NOT NULL,
  hit_count int NOT NULL DEFAULT '0',
  UNIQUE KEY socontenthitcountperhour_uk (date,hour,so_cd,file_name)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

CREATE TABLE tbl_llt_socontenthitcountperday (
  day_of_week tinyint NOT NULL COMMENT '요일',
  week_of_year tinyint NOT NULL COMMENT 'week number',
  date varchar(8) NOT NULL,
  so_cd varchar(45) NOT NULL,
  so_nm varchar(255) DEFAULT NULL,
  file_name varchar(100) NOT NULL,
  hit_count int NOT NULL DEFAULT '0',
  UNIQUE KEY socontenthitcountperday_uk (date,so_cd,file_name)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

CREATE TABLE tbl_llt_socontenthitcountpermonth (
  date varchar(6) NOT NULL,
  so_cd varchar(45) NOT NULL,
  so_nm varchar(255) DEFAULT NULL,
  file_name varchar(100) NOT NULL,
  hit_count int NOT NULL DEFAULT '0',
  UNIQUE KEY socontenthitcountpermonth_uk (date,so_cd,file_name)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

